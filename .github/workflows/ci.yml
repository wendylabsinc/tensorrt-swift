name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build & Test (GPU)
    runs-on: [self-hosted, rtx4090]
    container:
      image: nvcr.io/nvidia/tensorrt:24.12-py3
      options: --gpus all
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift 6.2
        run: |
          apt-get update && apt-get install -y curl gnupg
          curl -fsSL https://download.swift.org/swift-6.0.3-release/ubuntu2404/swift-6.0.3-RELEASE/swift-6.0.3-RELEASE-ubuntu24.04.tar.gz -o swift.tar.gz
          tar xzf swift.tar.gz -C /opt
          ln -sf /opt/swift-6.0.3-RELEASE-ubuntu24.04/usr/bin/* /usr/local/bin/
          swift --version

      - name: Verify CUDA & TensorRT
        run: |
          nvidia-smi
          echo "TensorRT version:"
          dpkg -l | grep -i tensorrt | head -5 || python3 -c "import tensorrt; print(tensorrt.__version__)"

      - name: Build Package
        run: |
          swift build -v

      - name: Run Tests
        run: |
          swift test -v
        env:
          LD_LIBRARY_PATH: /usr/lib/x86_64-linux-gnu:/usr/local/cuda/lib64

  build-only:
    name: Build Only (No GPU)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - name: Build (Linux stub)
        run: |
          swift build --target TensorRT || echo "Build requires TensorRT libraries - expected on non-GPU runners"
